/**
 * Theme: theme-Serenity
 * Author: Serenity
 * Build: 2026-02-19 12:33:02
 * Fingerprint: bd51e50c0a966e77
 * Copyright © 2026 Serenity. All rights reserved.
 * Unauthorized copying or distribution is prohibited.
 */
(function(){'use strict';var state={gamesPage:1,gamesTotal:0,gamesLoaded:[],heatmapLoaded:false};window.openSteamModal=function(){var modal=document.getElementById('steamModal');if(!modal)return;modal.classList.add('active');document.body.style.overflow='hidden';switchTab('heatmap');};window.closeSteamModal=function(){var modal=document.getElementById('steamModal');if(!modal)return;modal.classList.remove('active');document.body.style.overflow='';};document.addEventListener('keydown',function(e){if(e.key==='Escape')closeSteamModal();});window.switchTab=function(tabName){document.querySelectorAll('.steam-tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tabName);});document.querySelectorAll('.steam-tab-panel').forEach(function(p){p.classList.toggle('active',p.id==='steamPanel-'+tabName);});if(tabName==='heatmap'&&!state.heatmapLoaded){loadHeatmap();}if(tabName==='games'&&state.gamesLoaded.length===0){loadGames(1);}};function loadHeatmap(){var container=document.getElementById('steamHeatmapGrid');var monthsRow=document.getElementById('steamHeatmapMonths');if(!container)return;container.innerHTML='<div class="steam-loading"><div class="steam-loading-spinner"></div>加载中...</div>';var endDate=new Date();var startDate=new Date();startDate.setFullYear(startDate.getFullYear()-1);var startStr=formatDate(startDate);var endStr=formatDate(endDate);fetch('/apis/api.steam.timxs.com/v1alpha1/heatmap/records?startDate='+startStr+'&endDate='+endStr+'&size=366').then(function(r){return r.json();}).then(function(data){renderHeatmap(container,monthsRow,data.items||[],startDate,endDate);state.heatmapLoaded=true;}).catch(function(){container.innerHTML='<div class="steam-error">热力图数据加载失败</div>';});}function renderHeatmap(container,monthsRow,items,startDate,endDate){var dayMap={};items.forEach(function(item){var d=item.spec.date;dayMap[d]=(dayMap[d]||0)+(item.spec.playtimeMinutes||0);});var maxMin=0;Object.keys(dayMap).forEach(function(k){if(dayMap[k]>maxMin)maxMin=dayMap[k];});var cur=new Date(startDate);cur.setDate(cur.getDate()-cur.getDay());var html='';var months=[];var lastMonth=-1;var colIndex=0;var tooltip=document.getElementById('steamHeatmapTooltip');while(cur<=endDate){var ds=formatDate(cur);var mins=dayMap[ds]||0;var level=0;if(mins>0&&maxMin>0){var ratio=mins / maxMin;if(ratio<=0.25)level=1;else if(ratio<=0.5)level=2;else if(ratio<=0.75)level=3;else level=4;}if(cur.getDay()===0){var m=cur.getMonth();if(m !==lastMonth){months.push({month:m,col:colIndex});lastMonth=m;}colIndex++;}var timeStr=mins>0?formatMinutes(mins):'无游玩';html+='<div class="steam-heatmap-cell" data-level="'+level+'" data-date="'+ds+'" data-tip="'+ds+'：'+timeStr+'"></div>';cur.setDate(cur.getDate()+1);}container.innerHTML=html;var monthNames=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];if(monthsRow){var cellSize=15;var mHtml='';months.forEach(function(m,i){var nextCol=(i+1<months.length)?months[i+1].col:colIndex;var width=(nextCol-m.col)*cellSize;mHtml+='<span style="width:'+width+'px;display:inline-block">'+monthNames[m.month]+'</span>';});monthsRow.innerHTML=mHtml;}container.querySelectorAll('.steam-heatmap-cell').forEach(function(cell){cell.addEventListener('mouseenter',function(e){if(!tooltip)return;tooltip.textContent=cell.dataset.tip;tooltip.style.display='block';positionTooltip(e,tooltip);});cell.addEventListener('mousemove',function(e){if(tooltip)positionTooltip(e,tooltip);});cell.addEventListener('mouseleave',function(){if(tooltip)tooltip.style.display='none';});});}function positionTooltip(e,tooltip){tooltip.style.left=(e.clientX+10)+'px';tooltip.style.top=(e.clientY-30)+'px';}function loadGames(page){var grid=document.getElementById('steamGamesGrid');var btn=document.getElementById('steamLoadMore');if(!grid)return;if(page===1){grid.innerHTML='<div class="steam-loading"><div class="steam-loading-spinner"></div>加载中...</div>';}if(btn){btn.disabled=true;btn.textContent='加载中...';}fetch('/apis/api.steam.timxs.com/v1alpha1/games?page='+page+'&size=20&sortBy=playtime_forever').then(function(r){return r.json();}).then(function(data){var items=data.items||[];state.gamesTotal=data.total||0;state.gamesPage=page;if(page===1)grid.innerHTML='';items.forEach(function(game){var spec=game.spec||game;state.gamesLoaded.push(spec);var imgUrl=spec.headerImageUrl||('https://cdn.cloudflare.steamstatic.com/steam/apps/'+spec.appId+'/header.jpg');var playtime=formatMinutes(spec.playtimeForever||spec.playtime_forever||0);var card=document.createElement('div');card.className='steam-game-card';card.innerHTML='<img class="steam-game-card-img" src="'+imgUrl+'" alt="'+escHtml(spec.name||'')+'" loading="lazy" onerror="this.style.display=\'none\'">'+'<div class="steam-game-card-info"><div class="steam-game-card-name">'+escHtml(spec.name||'未知游戏')+'</div>'+'<div class="steam-game-card-playtime">总计 '+playtime+'</div></div>';grid.appendChild(card);});if(btn){var loaded=state.gamesLoaded.length;if(loaded>=state.gamesTotal){btn.style.display='none';}else{btn.disabled=false;btn.textContent='加载更多（'+loaded+' / '+state.gamesTotal+'）';btn.style.display='';}}}).catch(function(){if(page===1)grid.innerHTML='<div class="steam-error">游戏列表加载失败</div>';if(btn){btn.disabled=false;btn.textContent='重试';}});}window.loadMoreGames=function(){loadGames(state.gamesPage+1);};function formatDate(d){var y=d.getFullYear();var m=String(d.getMonth()+1).padStart(2,'0');var day=String(d.getDate()).padStart(2,'0');return y+'-'+m+'-'+day;}function formatMinutes(mins){if(mins<60)return mins+' 分钟';var h=Math.floor(mins / 60);var m=mins % 60;return m>0?h+' 小时 '+m+' 分钟':h+' 小时';}function escHtml(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}})();